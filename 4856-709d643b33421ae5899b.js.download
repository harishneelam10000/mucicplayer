"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4856],{24856:function(e,t,n){n.d(t,{U8:function(){return h.Barrier},dx:function(){return h.Debouncer},JT:function(){return h.Disposable},Q5:function(){return h.Emitter},Pd:function(){return k},Rc:function(){return we},eA:function(){return h.SliceList},$u:function(){return h.bedrockFS},MW:function(){return h.createMutex},PA:function(){return et},Sf:function(){return Xe},QL:function(){return h.newCuid},ot:function(){return h.ot},TF:function(){return f}});var r=n(51221),i=n(70233),s=n(62869),o=n(4908),a=n(55524),c=n(86362),u=n(45934),l=n.n(u),h=n(55397),f=n(73743),d=n(61570),m=n(5582),p=n(41669),v=n(88175),g=n(57252);function y(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function E(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?y(Object(n),!0).forEach((function(t){(0,p.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):y(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function w(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,c.Z)(e);if(t){var i=(0,c.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,a.Z)(this,n)}}var k=function(e){(0,o.Z)(n,e);var t=w(n);function n(e,r){var i;return(0,s.Z)(this,n),(i=t.call(this,e)).code=r,i}return(0,i.Z)(n,null,[{key:"match",value:function(e){return e instanceof n}},{key:"matchCode",value:function(e,t){return e instanceof n&&e.code===t}}]),n}((0,g.Z)(Error)),b=function(e){(0,o.Z)(n,e);var t=w(n);function n(e,r){var i,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:9e4;(0,s.Z)(this,n),(i=t.call(this))._hasResolved=!1,i.id=e;var a=E(E({},r),{},{id:e});return i.method=r.method,i.message=(0,f.createRequestPayload)(a),i.timeoutRef=setTimeout((function(){return i.dispose("Pitcher message ".concat(i.method," timed out"))}),o),i.promise=new Promise((function(e,t){i._resolve=e,i._reject=t})).then((function(e){if(e.status===f.PitcherResponseStatus.RESOLVED)return e.result;var t=new k(e.error.message,e.error.code);throw t.data=e.error.data,t})),i}return(0,i.Z)(n,[{key:"resolve",value:function(e){!this.isDisposed&&this._resolve&&(this._resolve(e),this._hasResolved=!0),this.dispose()}},{key:"reject",value:function(e){!this.isDisposed&&this._reject&&(this._reject(e),this._hasResolved=!0),this.dispose()}},{key:"unwrap",value:function(){return this.promise}},{key:"dispose",value:function(e){!this._hasResolved&&this._reject&&this._reject(new Error(null!==e&&void 0!==e?e:"Pitcher message ".concat(this.method," has been disposed"))),(0,v.Z)((0,c.Z)(n.prototype),"dispose",this).call(this),this.timeoutRef&&(clearTimeout(this.timeoutRef),this.timeoutRef=void 0)}}]),n}(h.Disposable);function C(e,t){var n="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"===typeof e)return S(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return S(e,t)}(e))||t&&e&&"number"===typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,o=!0,a=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){a=!0,s=e},f:function(){try{o||null==n.return||n.return()}finally{if(a)throw s}}}}function S(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var O=function(){function e(t,n){(0,s.Z)(this,e),this.onSendRequest=t,this.seamlessFork=n,this.nextMessageId=0,this.awaitReconnectQueue=[],this.pendingMessages=new Map,this.onInstanceChangeRequiredEmitter=new h.Emitter,this.onInstanceChangeRequired=this.onInstanceChangeRequiredEmitter.event,this.notificationListeners={},this.messageEmitter=new h.Emitter,this.onMessage=this.messageEmitter.event,this.errorEmitter=new h.Emitter,this.onError=this.errorEmitter.event}return(0,i.Z)(e,[{key:"onNotification",value:function(e,t){var n=this,r=this.notificationListeners[e];r||(r=this.notificationListeners[e]=new h.SliceList);var i=r.add(t);return function(){var t;null===(t=n.notificationListeners[e])||void 0===t||t.remove(i)}}},{key:"receiveMessage",value:function(e){var t=(0,f.decodeMessage)(e);this.messageEmitter.fire(t);var n=t.method;if((0,f.isNotificationPayload)(t)){var r=this.notificationListeners[n];if(r){var i,s=C(r.values());try{for(s.s();!(i=s.n()).done;){(0,i.value)(t.params)}}catch(c){s.e(c)}finally{s.f()}}}else{var o;if((0,f.isErrorPayload)(t))o={status:f.PitcherResponseStatus.REJECTED,error:{code:t.error.code,data:t.error.data,message:t.error.message},method:n};else{if(!(0,f.isResultPayload)(t))throw new Error("Unable to identify message type");o={status:f.PitcherResponseStatus.RESOLVED,result:t.result,method:n}}var a=this.pendingMessages.get(t.id);a&&a.resolve(o)}}},{key:"setOnSendRequest",value:function(e){this.onSendRequest=e}},{key:"request",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.timeoutMs,r=t.queueForReconnect,i=void 0===r||r,s=t.seamlessForkStrategy,o=this.createRequest(e,n);if(this.seamlessFork&&s)return"queue"===s?this.awaitReconnectQueue.push(o):o.dispose(),this.onInstanceChangeRequiredEmitter.fire(e),o.unwrap();try{return this.onSendRequest(o),o.unwrap()}catch(a){return i?(this.awaitReconnectQueue.push(o),o.unwrap()):(this.errorEmitter.fire({message:a.message,extras:{source:"pitcher-message-handler",type:"send-request",request:e}}),Promise.reject(a))}}},{key:"createRequest",value:function(e,t){var n=this,r=this.nextMessageId++,i=new b(r,e,t);return this.pendingMessages.set(r,i),i.onDidDispose((function(){return n.pendingMessages.delete(r)})),i}},{key:"getPendingMessages",value:function(){return this.pendingMessages}},{key:"disposePendingMessages",value:function(e){this.pendingMessages.forEach((function(t){e&&e.includes(t.message)||t.dispose()}))}},{key:"disableSeamlessFork",value:function(){this.seamlessFork=!1}},{key:"flushReconnectQueue",value:function(){var e=(0,r.Z)(l().mark((function e(){var t=this;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Promise.all(this.awaitReconnectQueue.map((function(e){return t.onSendRequest(e)})));case 3:this.awaitReconnectQueue.length=0,e.next=8;break;case 6:e.prev=6,e.t0=e.catch(0);case 8:case"end":return e.stop()}}),e,this,[[0,6]])})));return function(){return e.apply(this,arguments)}}()},{key:"dispose",value:function(){this.disposePendingMessages(),this.pendingMessages.clear(),this.notificationListeners={},this.errorEmitter.dispose(),this.messageEmitter.dispose()}}]),e}(),P=n(5850);n(73656);function R(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,c.Z)(e);if(t){var i=(0,c.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,a.Z)(this,n)}}var I=2e3,D=2e4,F=["CONNECTING","OPEN","CLOSING","CLOSED"];var N=function(e){(0,o.Z)(n,e);var t=R(n);function n(e){var i;if((0,s.Z)(this,n),(i=t.call(this)).bufferQueue=new h.SerialQueue("websocket-buffer-queue"),i.pongDetectionTimeout=D,i.onMessageEmitter=new h.Emitter,i.onDisconnectedEmitter=new h.Emitter,i.onMessage=i.onMessageEmitter.event,i.onDisconnected=i.onDisconnectedEmitter.event,i.lastActivity=Date.now(),e.readyState!==e.OPEN)throw new Error("Requires an OPEN websocket connection");i.ws=e,i.lastActivity=Date.now();var o=setInterval((function(){Date.now()-i.lastActivity>i.pingTimeout&&i.ping()}),i.pingTimeout);i.disposeWs=function(t){var n=t.reason,r=t.code,s=t.wasClean;console.info("WebSocket Disposed",F[e.readyState],n),clearInterval(o),clearTimeout(i.pongDetectionTimeout),e.removeEventListener("close",u),e.removeEventListener("message",a),e.removeEventListener("error",c),e.close(),i.onDisconnectedEmitter.fire({reason:n,code:r,wasClean:s}),i.onDisconnectedEmitter.dispose(),i.onMessageEmitter.dispose()};var a=function(e){i.lastActivity=Date.now();var t=e.data;clearTimeout(i.detectDisconnectByPongTimeout),t instanceof window.Blob?i.bufferQueue.add((0,r.Z)(l().mark((function e(){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=i,e.t1=Uint8Array,e.next=4,t.arrayBuffer();case 4:e.t2=e.sent,e.t3=new e.t1(e.t2),e.t0.emitMessage.call(e.t0,e.t3);case 7:case"end":return e.stop()}}),e)})))):"string"===typeof t||i.emitMessage(t)},c=function(){e.readyState!==e.CLOSING&&e.readyState!==e.CLOSED||i.disposeWs({code:-1,reason:"Error listener - "+F[e.readyState],wasClean:!1})},u=function(e){var t=e.wasClean,n=e.code,r=e.reason;return i.disposeWs({wasClean:t,code:n,reason:"Close listener - "+r})};return e.addEventListener("message",a),e.addEventListener("close",u),e.addEventListener("error",c),i}return(0,i.Z)(n,[{key:"emitMessage",value:function(e){this.onMessageEmitter.fire(e)}},{key:"pingTimeout",get:function(){return this.pongDetectionTimeout+I}},{key:"setPongDetectionTimeout",value:function(e){this.pongDetectionTimeout=e}},{key:"ping",value:function(e){var t=this;clearTimeout(this.detectDisconnectByPongTimeout),this.detectDisconnectByPongTimeout=setTimeout((function(){t.disposeWs({code:-1,reason:"Pong response not detected",wasClean:!1})}),e||this.pongDetectionTimeout),this.ws.send("")}},{key:"send",value:function(e){this.ws.readyState===this.ws.OPEN&&this.ws.send(e)}},{key:"close",value:function(){this.ws.close()}},{key:"silence",value:function(){this.onDisconnectedEmitter.dispose()}},{key:"dispose",value:function(){this.onDisconnectedEmitter.dispose(),this.disposeWs({reason:"DISPOSED",code:-1,wasClean:!0})}}]),n}(h.Disposable),H=function(e){return new Promise((function(t,n){var r=new P.Z(e),i=function(){o(),t(new N(r))},s=function(e){var t=e.message;o(),n(new Error(t))},o=function(){r.removeEventListener("open",i),r.removeEventListener("error",s)};r.addEventListener("open",i),r.addEventListener("error",s)}))};function Z(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function x(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Z(Object(n),!0).forEach((function(t){(0,p.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Z(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function T(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,c.Z)(e);if(t){var i=(0,c.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,a.Z)(this,n)}}var q=function(e){(0,o.Z)(n,e);var t=T(n);function n(e,r,i){var o;return(0,s.Z)(this,n),(o=t.call(this)).id=e,o.role=r,o.username=i,o.progressEmitter=new h.Emitter,o.onProgress=o.progressEmitter.event,o.doneEmitter=new h.Emitter,o.onDone=o.doneEmitter.event,o}return(0,i.Z)(n,[{key:"handleProgress",value:function(e){this.progressEmitter.fire(e)}},{key:"handleDone",value:function(){this.doneEmitter.fire()}}]),n}(h.Disposable),j=function(e){(0,o.Z)(n,e);var t=T(n);function n(e,r,i,o,a){var c;(0,s.Z)(this,n),(c=t.call(this)).messageHandler=o,c.aiClient=a,c.historyPromise=null,c.entries=[],c.isStreamingReply=!1,c.chatMessageEmitter=new h.Emitter,c.onChatMessage=c.chatMessageEmitter.event,c.chatMessageStartedEmitter=new h.Emitter,c.onChatMessageStarted=c.chatMessageStartedEmitter.event,c.chatTitleChangeEmitter=new h.Emitter,c.onChatTitleChange=c.chatTitleChangeEmitter.event,c.chatId=e,c.title=r,c.isUpToDate=i;var u=c.messageHandler.onNotification("ai/chatMessage",(function(e){if(e.chatId===c.chatId){var t=new q(e.messageId,e.role,e.username);if(c.chatMessageStartedEmitter.fire(t),e.isFinished||!e.messageId)c.addChatMessage(e,!0),c.chatMessageEmitter.fire(e),t.handleProgress(e.message),t.handleDone();else{c.isStreamingReply=!0;var n=c.aiClient.subscribeToMessage(e.messageId,(function(r,i){if(t.handleProgress(r),i){var s=x(x({},e),{},{message:r});c.addChatMessage(s,!0),c.isStreamingReply=!1,c.chatMessageEmitter.fire(s),n.dispose(),t.handleDone()}}))}}}));return c.onWillDispose((function(){return u()})),c}return(0,i.Z)(n,[{key:"addChatMessage",value:function(e,t){var n,r;t&&this.entries.length&&((null!==(n=null===(r=this.entries[this.entries.length-1])||void 0===r?void 0:r.idx)&&void 0!==n?n:0)!==e.idx-1&&(console.warn("Chat message got lost",this,e),this.fetchHistory()));this.entries.push({idx:e.idx,role:e.role,username:e.username,message:e.message,context:e.context})}},{key:"fetchHistory",value:function(){var e=this;return this.historyPromise||(this.historyPromise=this.messageHandler.request({method:"ai/chatHistory",params:{chatId:this.chatId}}).then((function(t){return e.isUpToDate=!0,e.entries=t.entries,e.entries})).catch((function(e){var t;return null!==(t=e.message)&&void 0!==t&&t.includes("not found")||console.error(e),[]})).finally((function(){e.historyPromise=null}))),this.historyPromise}},{key:"getHistory",value:function(){return this.isUpToDate?Promise.resolve(this.entries):this.fetchHistory()}},{key:"getHistorySync",value:function(){return this.entries}},{key:"sendMessage",value:function(){var e=(0,r.Z)(l().mark((function e(t){var n,r,i;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isStreamingReply){e.next=2;break}throw new Error("Cannot sent another request while we are waiting on a response");case 2:return n=(0,h.newCuid)(),e.next=5,this.messageHandler.request({method:"ai/chatMessage",params:x(x({},t),{},{messageId:n,chatId:this.chatId})});case 5:(r=e.sent).title!==this.title&&(this.title=r.title,this.chatTitleChangeEmitter.fire(this.title)),i=x(x({},t),{},{chatId:this.chatId,role:"user",idx:this.entries.length}),this.addChatMessage(i,!0);case 9:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"refresh",value:function(){var e=(0,r.Z)(l().mark((function e(){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.fetchHistory();case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()}]),n}(h.Disposable);function M(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,c.Z)(e);if(t){var i=(0,c.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,a.Z)(this,n)}}var L=function(e){(0,o.Z)(n,e);var t=M(n);function n(e,r){var i;(0,s.Z)(this,n),(i=t.call(this)).id=e,i.progressEmitter=new h.Emitter,i.onProgress=i.progressEmitter.event,i.doneEmitter=new h.Emitter,i.onDone=i.doneEmitter.event;var o=r.subscribeToMessage(e,(function(e,t){i.progressEmitter.fire(e),t&&i.doneEmitter.fire()}));return i.addDisposable(o),i}return n}(h.Disposable);function A(e,t){var n="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"===typeof e)return U(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return U(e,t)}(e))||t&&e&&"number"===typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,o=!0,a=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){a=!0,s=e},f:function(){try{o||null==n.return||n.return()}finally{if(a)throw s}}}}function U(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var B=function(){function e(t){var n=this;(0,s.Z)(this,e),this.messageHandler=t,this.chats=new Map,this.messageStates=new Map,this.messageProgressEmitter=new h.Emitter,this.onMessageProgress=this.messageProgressEmitter.event,this.chatsUpdatedEmitter=new h.Emitter,this.onChatsUpdated=this.chatsUpdatedEmitter.event,this.chatsErrorEmitter=new h.Emitter,this.onChatsError=this.chatsErrorEmitter.event,this.chatCreatedEmitter=new h.Emitter,this.onChatCreated=this.chatCreatedEmitter.event,this.chatMessageEmitter=new h.Emitter,this.onChatMessage=this.chatMessageEmitter.event,t.onNotification("ai/messageProgress",(function(e){var t,r=e.messageId,i=e.chunk,s=e.isFinished,o=null!==(t=n.messageStates.get(r))&&void 0!==t?t:{isFinished:s,content:""};o.content+=i,o.isFinished=s,n.messageStates.set(r,o),n.messageProgressEmitter.fire(r)})),t.onNotification("ai/chatCreated",(function(e){var r=new j(e.chatId,e.title,!0,t,n);r.entries=e.entries,n.chats.set(r.chatId,r),n.chatCreatedEmitter.fire(r),n.chatsUpdatedEmitter.fire(n.chats)})),t.onNotification("ai/chatMessage",(function(e){n.chatMessageEmitter.fire(e)}))}return(0,i.Z)(e,[{key:"subscribeToMessage",value:function(e,t){var n=this,r=this.onMessageProgress((function(r){if(r===e){var i=n.messageStates.get(e);i&&t(i.content,i.isFinished)}})),i=this.messageStates.get(e);return i&&t(i.content,i.isFinished),r}},{key:"fetchChats",value:function(){var e=this;this.messageHandler.request({method:"ai/chats",params:{}}).then((function(t){var n,r=A(t.chats);try{for(r.s();!(n=r.n()).done;){var i=n.value;if(!e.chats.get(i.chatId)){var s=new j(i.chatId,i.title,!1,e.messageHandler,e);e.chats.set(i.chatId,s),s.refresh()}e.chatsUpdatedEmitter.fire(e.chats)}}catch(o){r.e(o)}finally{r.f()}})).catch((function(t){e.chatsErrorEmitter.fire(t.message)}))}},{key:"resync",value:function(){this.fetchChats()}},{key:"suggestCommit",value:function(e){if(!e.files.length)throw new Error("Need to provide at least 1 file");return this.messageHandler.request({method:"ai/suggestCommit",params:e})}},{key:"raw",value:function(e){return this.messageHandler.request({method:"ai/raw",params:e})}},{key:"stream",value:function(){var e=(0,r.Z)(l().mark((function e(t){var n,r;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.messageHandler.request({method:"ai/stream",params:t});case 2:return n=e.sent,r=new L(n.messageId,this),e.abrupt("return",r);case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getChat",value:function(){var e=(0,r.Z)(l().mark((function e(t){var n,r,i;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.id,r=void 0===n?(0,h.newCuid)():n,!(i=this.chats.get(r))){e.next=4;break}return e.abrupt("return",i);case 4:return i=new j(r,"New chat",!0,this.messageHandler,this),this.chats.set(i.chatId,i),this.chatsUpdatedEmitter.fire(this.chats),e.next=9,i.getHistory();case 9:return e.abrupt("return",i);case 10:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),e}();function _(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,c.Z)(e);if(t){var i=(0,c.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,a.Z)(this,n)}}var V=function(e){(0,o.Z)(n,e);var t=_(n);function n(e,r){var i;return(0,s.Z)(this,n),(i=t.call(this)).name=e,i.messageHandler=r,i.onErrorEmitter=i.addDisposable(new h.Emitter),i.onJoinEmitter=i.addDisposable(new h.Emitter),i.onLeaveEmitter=i.addDisposable(new h.Emitter),i.onMessageEmitter=i.addDisposable(new h.Emitter),i.state={hasSubscribed:!1},i.subscribers=new Set,i.onError=i.onErrorEmitter.event,i.onSubscribe=i.onJoinEmitter.event,i.onUnsubscribe=i.onLeaveEmitter.event,i.onMessage=i.onMessageEmitter.event,i.onWillDispose((function(){i.unsubscribe(),i.subscribers=new Set,i.state.hasSubscribed&&i.state.disposeNotificationListeners()})),i}return(0,i.Z)(n,[{key:"listenToNotifications",value:function(){var e=this,t=this.messageHandler.onNotification("channel/message",(function(t){t.name===e.name&&e.onMessageEmitter.fire({clientId:t.clientId,data:t.data,isUser:t.isUser})})),n=this.messageHandler.onNotification("channel/subscribed",(function(t){t.name===e.name&&(e.subscribers=new Set(t.subscribers),e.onJoinEmitter.fire(t.clientId))})),r=this.messageHandler.onNotification("channel/unsubscribed",(function(t){t.name===e.name&&(e.subscribers=new Set(t.subscribers),e.onLeaveEmitter.fire(t.clientId))}));return function(){t(),n(),r()}}},{key:"subscribe",value:function(){var e=(0,r.Z)(l().mark((function e(){var t,n,r;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isDisposed){e.next=2;break}throw new Error("Channel is disposed");case 2:if(!0!==this.state.hasSubscribed){e.next=4;break}return e.abrupt("return");case 4:return t=this.listenToNotifications(),e.prev=5,e.next=8,this.messageHandler.request({method:"channel/subscribe",params:{name:this.name}});case 8:n=e.sent,this.subscribers=new Set(n.subscribers),this.state={hasSubscribed:!0,disposeNotificationListeners:t},e.next=19;break;case 13:throw e.prev=13,e.t0=e.catch(5),r=e.t0,t(),this.onErrorEmitter.fire({code:r.code,message:r.message}),new Error(r.message);case 19:case"end":return e.stop()}}),e,this,[[5,13]])})));return function(){return e.apply(this,arguments)}}()},{key:"unsubscribe",value:function(){var e=(0,r.Z)(l().mark((function e(){var t,n;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isDisposed){e.next=2;break}throw new Error("Channel is disposed");case 2:if(!1!==this.state.hasSubscribed){e.next=4;break}return e.abrupt("return");case 4:return this.state.disposeNotificationListeners(),this.state={hasSubscribed:!1},e.prev=6,e.next=9,this.messageHandler.request({method:"channel/unsubscribe",params:{name:this.name}});case 9:this.subscribers=new Set,this.state={hasSubscribed:!1},e.next=20;break;case 13:throw e.prev=13,e.t0=e.catch(6),t=this.listenToNotifications(),n=e.t0,this.state={hasSubscribed:!0,disposeNotificationListeners:t},this.onErrorEmitter.fire({code:n.code,message:n.message}),new Error(n.message);case 20:case"end":return e.stop()}}),e,this,[[6,13]])})));return function(){return e.apply(this,arguments)}}()},{key:"sendAll",value:function(e){if(this.isDisposed)throw new Error("Channel is disposed");return this.messageHandler.request({method:"channel/message",params:{data:e,name:this.name}})}},{key:"send",value:function(e,t){if(this.isDisposed)throw new Error("Channel is disposed");return this.messageHandler.request({method:"channel/message",params:{data:t,name:this.name,clients:Array.from(e)}})}}]),n}(h.Disposable);function W(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,c.Z)(e);if(t){var i=(0,c.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,a.Z)(this,n)}}var G=function(e){(0,o.Z)(n,e);var t=W(n);function n(e){var r,i=e.name,o=e.currentClient,a=e.clientClient,c=e.messageHandler;return(0,s.Z)(this,n),(r=t.call(this)).state=new d.G({state:"SOLO"}),r.name=i,r.hostChannel=new V("".concat(i,"-").concat(o.clientId),c),r.hostChannel.subscribe(),r.messageHandler=c,r.currentClient=o,r.addDisposable(a.onClientsUpdated((function(e){return r.updateChannels(e)}))),r.updateChannels(a.getClients()),r.onWillDispose((function(){r.hostChannel.dispose(),r.state.match({MULTIPLAYER:function(e){var t=e.channels;for(var n in t){var r;null===(r=t[n])||void 0===r||r.dispose()}},SOLO:function(){}})})),r}return(0,i.Z)(n,[{key:"updateChannels",value:function(e){var t=this,n=e.filter((function(e){return e.clientId!==t.currentClient.clientId&&e.username&&e.username===t.currentClient.username})).map((function(e){return e.clientId})),r=this.state.match({SOLO:function(){return t.state.set({state:"MULTIPLAYER",channels:{}}).channels},MULTIPLAYER:function(e){return e.channels}});for(var i in n.forEach((function(e){if(!r[e]){var n=new V("".concat(t.name,"-").concat(e),t.messageHandler);r[e]=n,n.subscribe()}})),r){var s=r[i];s&&!n.includes(i)&&(s.dispose(),delete r[i])}}},{key:"onMessage",value:function(e){return this.hostChannel.onMessage((function(t){t.isUser&&e(t)}))}},{key:"send",value:function(e){if(this.isDisposed)throw new Error("Channel is disposed");this.state.match({MULTIPLAYER:function(t){var n=t.channels;Object.values(n).forEach((function(t){return t.sendAll(e)}))},SOLO:function(){}})}}]),n}(h.Disposable);function J(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,c.Z)(e);if(t){var i=(0,c.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,a.Z)(this,n)}}var Q=function(e){(0,o.Z)(n,e);var t=J(n);function n(e,r,i){var o;return(0,s.Z)(this,n),(o=t.call(this)).name=e,o.messageHandler=r,o.currentClient=i,o.onFollowMessageEmitter=o.addDisposable(new h.Emitter),o.onFollowMessage=o.onFollowMessageEmitter.event,o.state={following:new d.G({state:"NOT_FOLLOWING"}),followers:new d.G({state:"NO_FOLLOWERS"})},o.hostChannel=new V("".concat(e,"-").concat(i.clientId),r),o.hostChannel.subscribe(),o.onFollowerJoin=o.hostChannel.onSubscribe,o.onFollowerLeave=o.hostChannel.onUnsubscribe,o.hostChannel.onSubscribe((function(e){o.state.followers.match({FOLLOWERS:function(t){var n=t.clientIds;return o.state.followers.set({state:"FOLLOWERS",clientIds:n.concat(e)})},NO_FOLLOWERS:function(){return o.state.followers.set({state:"FOLLOWERS",clientIds:[e]})}})})),o.hostChannel.onUnsubscribe((function(e){o.state.followers.match({FOLLOWERS:function(t){var n=t.clientIds.filter((function(t){return t!==e}));n.length?o.state.followers.set({state:"FOLLOWERS",clientIds:n}):o.state.followers.set({state:"NO_FOLLOWERS"})},NO_FOLLOWERS:function(){}})})),o.onWillDispose((function(){var e;o.hostChannel.dispose(),null===(e=o.followChannel)||void 0===e||e.dispose()})),o}return(0,i.Z)(n,[{key:"sendAllFollowers",value:function(e){if(this.hostChannel.subscribers.size>1)return this.hostChannel.sendAll(e)}},{key:"sendFollower",value:function(e,t){if(this.hostChannel.subscribers.has(e))return this.hostChannel.send(new Set([e]),t)}},{key:"follow",value:function(e){var t=this;e!==this.currentClient.clientId&&(this.followChannel&&this.followChannel.unsubscribe(),this.followChannel=new V("".concat(this.name,"-").concat(e),this.messageHandler),this.followChannel.subscribe(),this.followChannel.onMessage((function(e){t.onFollowMessageEmitter.fire(e)})),this.state.following.set({state:"FOLLOWING",clientId:e}))}},{key:"unfollow",value:function(){this.followChannel&&(this.followChannel.dispose(),delete this.followChannel,this.state.following.set({state:"NOT_FOLLOWING"}))}}]),n}(h.Disposable);function Y(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,c.Z)(e);if(t){var i=(0,c.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,a.Z)(this,n)}}var z=function(e){(0,o.Z)(n,e);var t=Y(n);function n(e,r){var i;return(0,s.Z)(this,n),(i=t.call(this)).channel=new V(e,r),i.channel.subscribe(),i.onWillDispose((function(){i.channel.dispose()})),i}return(0,i.Z)(n,[{key:"onJoin",value:function(e){if(this.isDisposed)throw new Error("Channel is disposed");return this.channel.onSubscribe(e)}},{key:"onLeave",value:function(e){if(this.isDisposed)throw new Error("Channel is disposed");return this.channel.onUnsubscribe(e)}},{key:"sendAll",value:function(e){if(this.isDisposed)throw new Error("Channel is disposed");if(this.channel.subscribers.size>1)return this.channel.sendAll(e)}},{key:"send",value:function(e,t){if(this.isDisposed)throw new Error("Channel is disposed");this.channel.subscribers.has(e)&&this.channel.send(new Set([e]),t)}},{key:"onMessage",value:function(e){if(this.isDisposed)throw new Error("Channel is disposed");return this.channel.onMessage(e)}}]),n}(h.Disposable),$=function(){function e(t){var n=t.messageHandler,r=t.currentClient,i=t.clientClient;(0,s.Z)(this,e),this.channels={raw:{},command:{},follow:{},shared:{}},this.currentClient=r,this.messageHandler=n,this.clientClient=i}return(0,i.Z)(e,[{key:"getChannel",value:function(e){return this.channels.raw[e]=this.channels.raw[e]||new V(e,this.messageHandler)}},{key:"getFollowChannel",value:function(e){return this.channels.follow[e]=this.channels.follow[e]||new Q(e,this.messageHandler,this.currentClient)}},{key:"getCommandChannel",value:function(e){return this.channels.command[e]=this.channels.command[e]||new G({name:e,clientClient:this.clientClient,currentClient:this.currentClient,messageHandler:this.messageHandler})}},{key:"getSharedChannel",value:function(e){return this.channels.shared[e]=this.channels.shared[e]||new z(e,this.messageHandler)}}]),e}(),K=function(){function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};(0,s.Z)(this,e),this.changeEmitter=new h.Emitter,this.onChange=this.changeEmitter.event,this.errorEmitter=new h.Emitter,this.onError=this.errorEmitter.event,this.value=t,this.getValue=n,r.fetchEagerly&&this.get()}return(0,i.Z)(e,[{key:"get",value:function(){var e=this;return this.initialValuePromise||(this.initialValuePromise=this.getValue().then((function(t){e.value=t,e.changeEmitter.fire({value:e.value,prevValue:e.value})})).catch((function(t){e.errorEmitter.fire(t.message)}))),this.value}},{key:"getInitPromise",value:function(){return this.initialValuePromise}},{key:"set",value:function(e){var t=this.value;return this.value=e,this.changeEmitter.fire({value:this.value,prevValue:t}),this.value}},{key:"update",value:function(e){var t=this.value;return this.value=e(this.value),this.changeEmitter.fire({value:this.value,prevValue:t}),this.value}},{key:"refresh",value:function(){var e=this;this.getValue().then((function(t){return e.set(t)}))}}]),e}();function X(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function ee(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?X(Object(n),!0).forEach((function(t){(0,p.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):X(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var te=function(){function e(t){var n=this;(0,s.Z)(this,e),this.messageHandler=t,this.clientConnectedEmitter=new h.Emitter,this.onClientConnected=this.clientConnectedEmitter.event,this.clientDisconnectedEmitter=new h.Emitter,this.onClientDisconnected=this.clientDisconnectedEmitter.event,this.clientUpdatedEmitter=new h.Emitter,this.onClientUpdated=this.clientUpdatedEmitter.event,this.clientPermissionsEmitter=new h.Emitter,this.onClientPermissionsUpdated=this.clientPermissionsEmitter.event,this.clientsUpdatedEmitter=new h.Emitter,this.onClientsUpdated=this.clientsUpdatedEmitter.event,this.clientsErrorEmitter=new h.Emitter,this.onClientsError=this.clientsErrorEmitter.event,this.clients=this.createClientsValue(),t.onNotification("client/connected",(function(e){n.clients.update((function(t){return t.find((function(t){return t.clientId===e.clientId}))?t.map((function(t){return t.clientId===e.clientId?ee(ee({},e),{},{avatarUrl:t.avatarUrl}):t})):t.concat(e)})),n.clientConnectedEmitter.fire(e)})),t.onNotification("client/disconnected",(function(e){var t=e.clientId,r=e.reason;t!==n.currentClientId&&(n.clients.update((function(e){return e.filter((function(e){return e.clientId!==t}))})),n.clientDisconnectedEmitter.fire({clientId:t,reason:r}))})),t.onNotification("client/updated",(function(e){n.clients.update((function(t){return t.map((function(t){return t.clientId===e.clientId?e:t}))})),n.clientUpdatedEmitter.fire(e)})),t.onNotification("client/permissions",(function(e){n.clientPermissionsEmitter.fire(e)}))}return(0,i.Z)(e,[{key:"createClientsValue",value:function(){var e=this,t=new K([],(function(){return e.messageHandler.request({method:"client/list",params:{}})}));return t.onChange((function(t){var n=t.value;return e.clientsUpdatedEmitter.fire(n)})),t.onError((function(t){return e.clientsErrorEmitter.fire(t)})),t}},{key:"join",value:function(){var e=(0,r.Z)(l().mark((function e(t){var n,r;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.messageHandler.request({method:"client/join",params:t},{timeoutMs:36e5,queueForReconnect:!1});case 2:return n=e.sent,r=n.client,this.currentClientId=n.client.clientId,this.clients.update((function(e){var t=e.find((function(e){return e.clientId===r.clientId}));return t?[ee(ee({},r),{},{avatarUrl:t.avatarUrl})]:[r]})),e.abrupt("return",n);case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getClients",value:function(){return this.clients.get()}},{key:"resync",value:function(){return this.clients.refresh()}}]),e}(),ne=function(){function e(t){var n=this;(0,s.Z)(this,e),this.messageHandler=t,this.commandsUpdatedEmitter=new h.Emitter,this.onCommandsUpdated=this.commandsUpdatedEmitter.event,this.commandsErrorEmitter=new h.Emitter,this.onCommandsError=this.commandsErrorEmitter.event,this.commands=this.createCommandsValue(),t.onNotification("command/changed",(function(e){var t=e.commands;n.commands.set(t)}))}return(0,i.Z)(e,[{key:"createCommandsValue",value:function(){var e=this,t=new K([],(function(){return e.messageHandler.request({method:"command/list",params:{}}).then((function(e){return e.commands}))}));return t.onChange((function(t){var n=t.value;return e.commandsUpdatedEmitter.fire(n)})),t.onError((function(t){return e.commandsErrorEmitter.fire(t)})),t}},{key:"getCommands",value:function(){return this.commands.get()}},{key:"resync",value:function(){return this.commands.refresh()}},{key:"executeCommand",value:function(){var e=(0,r.Z)(l().mark((function e(t){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.messageHandler.request({method:"command/execute",params:{commandId:t}});case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),e}(),re=n(77410),ie=n(88031);function se(e,t){var n="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"===typeof e)return oe(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return oe(e,t)}(e))||t&&e&&"number"===typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,o=!0,a=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){a=!0,s=e},f:function(){try{o||null==n.return||n.return()}finally{if(a)throw s}}}}function oe(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var ae=function(){function e(){(0,s.Z)(this,e),this.pendingOperations=new Map,this.revertOperations=new Map,this.messageId=0,this.incomingOperations=new Set,this.remoteClock=0,this.tree=new h.bedrockFS.Tree}return(0,i.Z)(e,[{key:"populateTreeFromJSON",value:function(e){this.remoteClock=e.clock,this.tree=h.bedrockFS.Tree.fromJSON(e.treeNodes),this.syncFSTree([])}},{key:"applyOperation",value:function(e){switch(e.type){case"create":var t=this.tree.getNodeById(e.parentId);if(null===t||void 0===t||!t.isDirNode())return!1;switch(e.newEntry.type){case h.bedrockFS.NodeType.File:t.createFileWithId(e.newEntry.id,e.newEntry.name);break;case h.bedrockFS.NodeType.Directory:t.createDirectoryWithId(e.newEntry.id,e.newEntry.name)}return{type:"delete",id:e.newEntry.id};case"delete":var n,r=this.tree.getNodeById(e.id);return!(null===r||void 0===r||!r.parentId)&&(this.tree.deleteNode(e.id),{type:"create",parentId:r.parentId,newEntry:{id:r.id,type:r.type,name:null!==(n=r.name)&&void 0!==n?n:""}});case"move":var i,s=this.tree.getNodeById(e.id);if(!s)return!1;var o={type:"move",id:e.id};o.parentId=s.parentId,e.name&&(o.name=s.name);var a=null!==(i=e.parentId)&&void 0!==i?i:s.parentId;if(!a)throw new Error("Move requires a parentId");return this.tree.moveNode(e.id,a,e.name),o}}},{key:"applyPendingOperation",value:function(e){this.messageId++,this.pendingOperations.set(this.messageId,e);var t=this.applyOperation(e);return t?(this.revertOperations.set(this.messageId,t),this.messageId):(this.pendingOperations.delete(this.messageId),!1)}},{key:"receiveNotification",value:function(e){this.incomingOperations.add(e)}},{key:"syncFSTree",value:function(e){var t,n=0,r=(0,ie.Z)(this.incomingOperations).sort((function(e,t){return e.clock-t.clock})),i=se(this.revertOperations.values());try{for(i.s();!(t=i.n()).done;){var s=t.value;this.applyOperation(s)}}catch(y){i.e(y)}finally{i.f()}var o,a=this.remoteClock+1,c=se(r);try{for(c.s();!(o=c.n()).done;){var u=o.value;u.clock<a?this.incomingOperations.delete(u):u.clock===a&&(this.applyOperation(u.operation),this.incomingOperations.delete(u),this.remoteClock=u.clock,n++),a++}}catch(y){c.e(y)}finally{c.f()}var l,h=se(e);try{for(h.s();!(l=h.n()).done;){var f=l.value;this.pendingOperations.delete(f),this.revertOperations.delete(f)}}catch(y){h.e(y)}finally{h.f()}var d,m=se(this.pendingOperations.keys());try{for(m.s();!(d=m.n()).done;){var p=d.value,v=this.pendingOperations.get(p);if(v){var g=this.applyOperation(v);g?(this.revertOperations.set(p,g),n++):(this.revertOperations.delete(p),this.pendingOperations.delete(p))}}}catch(y){m.e(y)}finally{m.f()}return n}},{key:"getPathFromId",value:function(e){var t=this.tree.getNodeById(e);if(t)return t.path}},{key:"getIdFromPath",value:function(e){return this.tree.getIdFromPath(e)}},{key:"getNodeById",value:function(e){return this.tree.getNodeById(e)}}]),e}();function ce(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function ue(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ce(Object(n),!0).forEach((function(t){(0,p.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ce(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function le(e,t){var n="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"===typeof e)return he(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return he(e,t)}(e))||t&&e&&"number"===typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,o=!0,a=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){a=!0,s=e},f:function(){try{o||null==n.return||n.return()}finally{if(a)throw s}}}}function he(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var fe=new RegExp(/^\/project\/home\/[a-zA-Z0-9 -_]+\/workspace/gm),de=[new RegExp(/^\/workspace/gm),fe,new RegExp(/^\/project\/.*?\//gm)];function me(e){var t,n=le(de);try{for(n.s();!(t=n.n()).done;){var r=t.value;if(r.test(e))return e.replace(r,"")}}catch(i){n.e(i)}finally{n.f()}return e}var pe=function(){function e(t,n){var r=this;(0,s.Z)(this,e),this.workspacePath=t,this.messageHandler=n,this.memoryFS=new ae,this.operationQueue=new h.SerialQueue("fs-client"),this.onFSErrorEmitter=new h.Emitter,this.onFSError=this.onFSErrorEmitter.event,this.onFSSyncEmitter=new h.Emitter,this.onFSSync=this.onFSSyncEmitter.event,this.onPendingOperationsChangeEmitter=new h.Emitter,this.onPendingOperationsChange=this.onPendingOperationsChangeEmitter.event,this.getPathFromId=this.memoryFS.getPathFromId.bind(this.memoryFS),this.getIdFromPath=this.memoryFS.getIdFromPath.bind(this.memoryFS),n.onNotification("fs/operations",(function(e){var t,n=le(e.operations);try{for(n.s();!(t=n.n()).done;){var i=t.value;r.memoryFS.receiveNotification(i);var s=r.memoryFS.syncFSTree([]);r.onFSSyncEmitter.fire({opCount:s})}}catch(o){n.e(o)}finally{n.f()}})),this.readyPromise=this.readFs()}return(0,i.Z)(e,[{key:"asRelativeWorkspacePath",value:function(e){return(0,re.join)("/",e)}},{key:"asAbsoluteWorkspacePath",value:function(e){return(0,re.join)(this.workspacePath,me(e))}},{key:"absoluteToRelativeWorkspacePath",value:function(e){return(0,re.join)("/",me(e))}},{key:"relativeToAbsoluteWorkspacePath",value:function(e){return(0,re.join)(this.workspacePath,e)}},{key:"resolveRelativeWorkspacePath",value:function(e){return(0,re.join)("/",me(e))}},{key:"resolveAbsoluteWorkspacePath",value:function(e){return this.asAbsoluteWorkspacePath(e)}},{key:"getPendingOperations",value:function(){return Array.from(this.memoryFS.pendingOperations.values())}},{key:"readFs",value:function(){var e=this;return this.messageHandler.request({method:"fs/read",params:null}).then((function(t){return e.memoryFS.populateTreeFromJSON(t)}))}},{key:"resync",value:function(){var e=(0,r.Z)(l().mark((function e(){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.readFs().catch(console.error));case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"applyFSOperation",value:function(e){var t=this,n=this.memoryFS.applyPendingOperation(e);return!1===n?Promise.resolve():(this.onPendingOperationsChangeEmitter.fire(this.getPendingOperations()),this.operationQueue.add((function(){return t.messageHandler.request({method:"fs/operation",params:{operation:e}},{seamlessForkStrategy:"queue"}).then((function(n){n.code===f.fs.FSOperationResponseCode.Success&&t.memoryFS.receiveNotification({clock:n.clock,operation:e})})).catch((function(e){t.onFSErrorEmitter.fire({message:e.message})})).finally((function(){var e=t.memoryFS.syncFSTree([n]);t.onFSSyncEmitter.fire({opCount:e}),t.onPendingOperationsChangeEmitter.fire(t.getPendingOperations())}))})))}},{key:"createParentDirs",value:function(e,t){var n=this,r=this.memoryFS.tree.getNodeById(t);if(!r||!r.isDirNode())throw new Error(r?"".concat(r.path," is not a directory"):"Parent directory not found");var i,s=le(e);try{var o=function(){var e=i.value,t=r.children.find((function(t){return t.name===e}));if(t){if(!t.isDirNode())throw new Error("".concat(t.path," already exists but is not a directory"));r=t}else{var s=n.createNewDirectory(e,r.id);r=n.memoryFS.tree.getNodeById(s)}};for(s.s();!(i=s.n()).done;)o()}catch(a){s.e(a)}finally{s.f()}return r}},{key:"createFile",value:function(){var e=(0,r.Z)(l().mark((function e(t,n){var r,i,s,o;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.split("/").filter(Boolean),i=r.pop()){e.next=4;break}throw new Error("File name is undefined");case 4:return s=this.createParentDirs(r,n),o=(0,h.newCuid)(),e.next=8,this.applyFSOperation({type:"create",parentId:s.id,newEntry:{id:o,type:h.bedrockFS.NodeType.File,name:i}}).catch(console.error);case 8:return e.abrupt("return",{id:o,filepath:this.getPathFromId(o)});case 9:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"isFile",value:function(e){var t=this.memoryFS.getNodeById(e);return!!t&&t.isFile()}},{key:"createNewDirectory",value:function(e,t){var n=(0,h.newCuid)();return this.applyFSOperation({type:"create",parentId:t,newEntry:{id:n,type:h.bedrockFS.NodeType.Directory,name:e}}).catch(console.error),n}},{key:"createDirectory",value:function(e,t){var n=e.split("/").filter(Boolean);if(!n.length)throw new Error("Directory name is undefined");return this.createParentDirs(n,t).id}},{key:"deleteNode",value:function(e){this.applyFSOperation({type:"delete",id:e}).catch(console.error)}},{key:"move",value:function(e,t){var n=t.newName,r=t.newParentId;this.applyFSOperation({type:"move",id:e,parentId:r,name:n}).catch(console.error)}},{key:"search",value:function(){var e=(0,r.Z)(l().mark((function e(t){var n,r,i;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.messageHandler.request({method:"fs/search",params:t});case 2:return n=e.sent,r=new TextEncoder,i=new TextDecoder,e.abrupt("return",n.map((function(e){var t=e.submatches,n=[],s=e.lines.text;if(t.length>0){var o,a=r.encode(s),c=le(t);try{for(c.s();!(o=c.n()).done;){var u=o.value,l=i.decode(a.slice(0,u.start)).length,h=l+u.match.text.length;n.push(ue(ue({},u),{},{start:l,end:h}))}}catch(d){c.e(d)}finally{c.f()}}else{var f;n.push({start:0,end:1,match:{text:null!==(f=s[0])&&void 0!==f?f:""}})}return ue(ue({},e),{},{submatches:n})})));case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"pathSearch",value:function(e){return this.messageHandler.request({method:"fs/pathSearch",params:e})}},{key:"uploadFile",value:function(){var e=(0,r.Z)(l().mark((function e(t,n,r){var i,s,o,a;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=t.split("/").filter(Boolean),s=i.pop()){e.next=4;break}throw new Error("File name is undefined");case 4:return o=this.createParentDirs(i,r),e.next=7,this.messageHandler.request({method:"fs/upload",params:{parentId:o.id,filename:s,content:n}},{seamlessForkStrategy:"queue"});case 7:return a=e.sent,e.abrupt("return",{id:a.fileId,filepath:this.getPathFromId(a.fileId)});case 9:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"download",value:function(){var e=(0,r.Z)(l().mark((function e(t){var n;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.messageHandler.request({method:"fs/download",params:{path:t||this.workspacePath}},{});case 2:return n=e.sent,e.abrupt("return",{downloadUrl:n.downloadUrl});case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"readFile",value:function(){var e=(0,r.Z)(l().mark((function e(t){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.handleRawFsResponse("fs/readFile",{path:t}));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"readdir",value:function(){var e=(0,r.Z)(l().mark((function e(t){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.handleRawFsResponse("fs/readdir",{path:t}));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"writeFile",value:function(){var e=(0,r.Z)(l().mark((function e(t,n,r,i){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.handleRawFsResponse("fs/writeFile",{path:t,content:n,create:r,overwrite:i}));case 1:case"end":return e.stop()}}),e,this)})));return function(t,n,r,i){return e.apply(this,arguments)}}()},{key:"stat",value:function(){var e=(0,r.Z)(l().mark((function e(t){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.handleRawFsResponse("fs/stat",{path:t}));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"copy",value:function(){var e=(0,r.Z)(l().mark((function e(t,n,r,i){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.handleRawFsResponse("fs/copy",{from:t,to:n,recursive:r,overwrite:i}));case 1:case"end":return e.stop()}}),e,this)})));return function(t,n,r,i){return e.apply(this,arguments)}}()},{key:"rename",value:function(){var e=(0,r.Z)(l().mark((function e(t,n,r){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.handleRawFsResponse("fs/rename",{from:t,to:n,overwrite:r}));case 1:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"remove",value:function(){var e=(0,r.Z)(l().mark((function e(t,n){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.handleRawFsResponse("fs/remove",{path:t,recursive:n}));case 1:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"mkdir",value:function(){var e=(0,r.Z)(l().mark((function e(t,n){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.handleRawFsResponse("fs/mkdir",{path:t,recursive:n}));case 1:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"watch",value:function(){var e=(0,r.Z)(l().mark((function e(t,n,r){var i,s,o=this;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.handleRawFsResponse("fs/watch",{path:t,recursive:n.recursive,excludes:n.excludes});case 2:if("error"!==(i=e.sent).type){e.next=5;break}return e.abrupt("return",i);case 5:return s=i.result.watchId,this.messageHandler.onNotification("fs/watchEvent",(function(e){e.watchId===s&&e.events.forEach(r)})),e.abrupt("return",{type:"success",dispose:function(){o.handleRawFsResponse("fs/unwatch",{watchId:s})}});case 8:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"handleRawFsResponse",value:function(){var e=(0,r.Z)(l().mark((function e(t,n){var r,i;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.messageHandler.request({method:t,params:n},{});case 3:return r=e.sent,e.abrupt("return",{type:"ok",result:r});case 7:if(e.prev=7,e.t0=e.catch(0),!("code"in(i=e.t0))){e.next=14;break}if(i.code!==f.PitcherErrorCode.RAWFS_ERROR){e.next=13;break}return e.abrupt("return",{type:"error",error:i.message,errno:i.data.errno});case 13:return e.abrupt("return",{type:"error",error:i.message,errno:null});case 14:if(!(i instanceof Error)){e.next=16;break}return e.abrupt("return",{type:"error",error:i.message,errno:null});case 16:return e.abrupt("return",{type:"error",error:"unknown error",errno:null});case 17:case"end":return e.stop()}}),e,this,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}()}]),e}(),ve=n(20589);function ge(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,c.Z)(e);if(t){var i=(0,c.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,a.Z)(this,n)}}var ye=function(e){(0,o.Z)(n,e);var t=ge(n);function n(e,r){var i;return(0,s.Z)(this,n),(i=t.call(this)).rc=e,i.onWillDispose((function(){i.isDisposed||r()})),i}return(0,i.Z)(n,[{key:"object",get:function(){return this.rc.object}}]),n}(h.Disposable),Ee="ENABLED"===localStorage.getItem("CSB_RC_DEBUG");Ee&&(window.RC_DEBUG={traceLog:[],counters:new Map});var we=function(e){(0,o.Z)(n,e);var t=ge(n);function n(e,r){var i;return(0,s.Z)(this,n),(i=t.call(this)).object=e,i.count=0,i.onWillDispose(r),n.trace("rc.create",(0,ve.Z)(i)),i}return(0,i.Z)(n,[{key:"acquire",value:function(){var e=this;if(this.isDisposed)throw new Error("Cannot re-acquire a destroyed Rc");return this.count+=1,n.trace("rc.aquire",this),new ye(this,(function(){if(e.count-=1,n.trace("rc.drop",e),0===e.count)return n.trace("rc.dispose",e),(0,v.Z)((0,c.Z)(n.prototype),"dispose",e).call(e)}))}},{key:"dispose",value:function(){throw new Error("Cannot call dispose directly, need to use the RcRef")}}],[{key:"trace",value:function(e,t){if(Ee)try{throw new Error("RC_TRACE")}catch(c){if(c instanceof Error){var r=(c.stack||"").split("\n").filter((function(e){return!e.includes("node_modules")&&!e.includes("Rc.js")&&!e.includes("RC_TRACE")&&e.match(/[a-zA-Z0-9_-]+/)})),i=r[0],s=window.RC_DEBUG,o={event:e,ref:t instanceof n?t.object:t,count:t instanceof n?t.count:0,location:"..."+i.substring(i.length-50),stack:r};if(s.traceLog.push(o),!(t instanceof n))return;var a=s.counters.get(t.object);a?a.push(o):s.counters.set(t.object,[o])}}}}]),n}(h.Disposable),ke=n(87795),be=function(){function e(t,n,r){var i=this;(0,s.Z)(this,e),this.onIncomingOperationEmitter=new h.Emitter,this.onIncomingOperation=this.onIncomingOperationEmitter.event,this.onOperationAckEmitter=new h.Emitter,this.onOperationAck=this.onOperationAckEmitter.event,this.onSelectionEmitter=new h.Emitter,this.onSelection=this.onSelectionEmitter.event,this.onErrorEmitter=new h.Emitter,this.onError=this.onErrorEmitter.event,this.clientSelections=new Map,this.syncState="SYNCED",this.file=t,this.messageHandler=r,this.clientSelections=new Map(Object.entries(n.clients).map((function(e){var t=(0,ke.Z)(e,2);return[t[0],t[1]]}))),this.file.onWillClientJoin((function(e){var t=e.clientId;i.clientSelections.set(t,null)})),this.file.onWillClientLeave((function(e){var t=e.clientId;i.clientSelections.delete(t)})),this.otClient=this.createOTClient(this.file.content,n.revision),r.onMessage((function(e){(function(e){return(0,f.isResultPayload)(e)&&"file/documentOperation"===e.method&&e.status===f.PitcherResponseStatus.RESOLVED})(e)&&Boolean(!("id"in e.result)||e.result.id===i.file.id)&&i.otClient.serverAck()})),r.onNotification("file/documentOperation",(function(e){var t=e.id,n=e.operation,r=e.revision,s=e.reason;if(t===i.file.id&&"RESYNCING"!==i.syncState)try{var o=h.ot.TextOperation.fromJSON(n);i.otClient.applyServerOperation(o,s)}catch(a){i.syncState="RESYNCING",i.file.resync().catch((function(e){i.onErrorEmitter.fire({error:e.message,metadata:{type:"ot-resync-error"}})})),i.onErrorEmitter.fire({error:a.message,metadata:{type:"ot-received-invalid-operation",operation:JSON.stringify(n,null,2),revision:r}})}})),r.onNotification("file/documentSelection",(function(e){var t=e.id,n=e.selections,r=e.reason;t===i.file.id&&(Object.entries(n).forEach((function(e){var t=(0,ke.Z)(e,2),n=t[0],r=t[1];i.clientSelections.has(n)&&i.clientSelections.set(n,r)})),i.onSelectionEmitter.fire({clientSelections:i.clientSelections,reason:r}))}))}return(0,i.Z)(e,[{key:"createOTClient",value:function(e,t){var n=this,i=new h.ot.Client(e,t,(function(e,t){n.sendDocumentOperation(t,e).catch((function(r){"RESYNCING"!==n.syncState&&r instanceof k&&(n.syncState="RESYNCING",n.file.resync().catch((function(e){n.onErrorEmitter.fire({error:e.message,metadata:{type:"ot-resync-error"}})})),n.onErrorEmitter.fire({error:r.message,metadata:{type:"ot-send-document-operation",operation:JSON.stringify(t.toJSON(),null,2),code:r.code,revision:e}}))}))}),function(){var e=(0,r.Z)(l().mark((function e(t){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,n.sendDocumentAck(t);case 3:e.next=8;break;case 5:e.prev=5,e.t0=e.catch(0),n.onErrorEmitter.fire({error:e.t0.message,metadata:{type:"ot-send-document-ack",revision:t}});case 8:case"end":return e.stop()}}),e,null,[[0,5]])})));return function(t){return e.apply(this,arguments)}}());return i.onDocumentChange((function(e){var t=e.newContent;n.file.updateContent(t)})),i.onIncomingOperation((function(e){n.onIncomingOperationEmitter.fire({revision:e.revision,clientSelections:n.clientSelections,operation:e.operation,reason:e.reason})})),i.onOperationAck((function(e){var t=e.revision;n.onOperationAckEmitter.fire({clientSelections:n.clientSelections,revision:t})})),i}},{key:"resync",value:function(e,t){this.otClient.syncServerDocument(e,t),this.syncState="SYNCED"}},{key:"reset",value:function(e,t){this.otClient.dispose(),this.otClient=this.createOTClient(e,t)}},{key:"sendDocumentAck",value:function(e){return this.messageHandler.request({method:"file/documentAck",params:{id:this.file.id,revision:e}})}},{key:"sendDocumentOperation",value:function(e,t){return this.messageHandler.request({method:"file/documentOperation",params:{id:this.file.id,operation:e.toJSON(),revision:t}},{seamlessForkStrategy:"dispose",queueForReconnect:!1})}},{key:"applyClient",value:function(e){this.otClient.applyClientOperation(e)}},{key:"sendSelection",value:function(e,t){return this.messageHandler.request({method:"file/documentSelection",params:{id:this.file.id,selection:e,reason:t}},{queueForReconnect:!1}).then((function(){})).catch((function(){}))}},{key:"dispose",value:function(){this.onIncomingOperationEmitter.dispose(),this.onOperationAckEmitter.dispose(),this.onErrorEmitter.dispose(),this.onSelectionEmitter.dispose()}}]),e}();function Ce(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,c.Z)(e);if(t){var i=(0,c.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,a.Z)(this,n)}}var Se=function(e){(0,o.Z)(n,e);var t=Ce(n);function n(e,r,i){var o;return(0,s.Z)(this,n),(o=t.call(this)).onDidSaveEmitter=new h.Emitter,o.onDidSave=o.onDidSaveEmitter.event,o.onDidContentChangeEmitter=new h.Emitter,o.onDidContentChange=o.onDidContentChangeEmitter.event,o.onWillClientJoinEmitter=new h.Emitter,o.onWillClientJoin=o.onWillClientJoinEmitter.event,o.onDidClientJoinEmitter=new h.Emitter,o.onDidClientJoin=o.onDidClientJoinEmitter.event,o.onWillClientLeaveEmitter=new h.Emitter,o.onWillClientLeave=o.onWillClientLeaveEmitter.event,o.onDidClientLeaveEmitter=new h.Emitter,o.onDidClientLeave=o.onDidClientLeaveEmitter.event,o.onDidMoveEmitter=new h.Emitter,o.onDidMove=o.onDidMoveEmitter.event,o.clients={},o.document=null,o.path=e,o.id=r.id,o.savedHash=r.savedHash,o.messageHandler=i,o.content=r.content,o.isBinary=r.isBinary,o.clients=r.clients,o.contentHash="string"===r.content?(0,h.murmur)(r.content):r.savedHash,r.document&&(o.document=new be((0,ve.Z)(o),r.document,i)),i.onNotification("file/save",(function(e){var t=e.id,n=e.savedHash;t===o.id&&(o.savedHash=n,o.onDidSaveEmitter.fire({savedHash:n}))})),i.onNotification("file/join",(function(e){var t=e.id,n=e.username,r=e.clientId;t===o.id&&(o.onWillClientJoinEmitter.fire({clientId:r,username:n}),o.clients[r]={username:n},o.onDidClientJoinEmitter.fire({clientId:r,username:n,clients:o.clients}))})),i.onNotification("file/leave",(function(e){var t=e.id,n=e.clientId,r=e.username;t===o.id&&(o.onWillClientLeaveEmitter.fire({clientId:n,username:r}),delete o.clients[n],o.onDidClientLeaveEmitter.fire({clientId:n,username:r,clients:o.clients}))})),o.onWillDispose((function(){var e;o.onDidSaveEmitter.dispose(),o.onDidContentChangeEmitter.dispose(),o.onWillClientJoinEmitter.dispose(),o.onDidClientJoinEmitter.dispose(),o.onWillClientLeaveEmitter.dispose(),o.onDidClientLeaveEmitter.dispose(),null===(e=o.document)||void 0===e||e.dispose()})),o}return(0,i.Z)(n,[{key:"isDirty",get:function(){return this.contentHash!==this.savedHash}},{key:"updatePath",value:function(e){this.path=e,this.onDidMoveEmitter.fire(e)}},{key:"resync",value:function(){var e=(0,r.Z)(l().mark((function e(){var t;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.document){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this.messageHandler.request({method:"file/open",params:{id:this.id,isResync:!0}},{queueForReconnect:!1});case 4:t=e.sent,this.savedHash=t.savedHash,t.document&&"string"===typeof t.content&&this.document.resync(t.content,t.document.revision);case 7:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"resetFromServer",value:function(){var e=(0,r.Z)(l().mark((function e(){var t;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.document){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this.messageHandler.request({method:"file/open",params:{id:this.id,isResync:!0}},{queueForReconnect:!1});case 4:if(!(t=e.sent).document||"string"!==typeof t.content){e.next=8;break}return this.document.reset(t.content,t.document.revision),e.abrupt("return",t.content);case 8:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"resetFromClient",value:function(){var e=(0,r.Z)(l().mark((function e(t){var n;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.document){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this.messageHandler.request({method:"file/open",params:{id:this.id,isResync:!0}},{queueForReconnect:!1});case 4:(n=e.sent).document&&"string"===typeof n.content&&(this.document.reset(n.content,n.document.revision),this.document.otClient.applyClientDocument(t));case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"updateContent",value:function(e){this.content=e,this.contentHash=(0,h.murmur)(e),this.onDidContentChangeEmitter.fire({contentHash:this.contentHash,newContent:this.content})}},{key:"save",value:function(){return this.messageHandler.request({method:"file/save",params:{id:this.id}},{seamlessForkStrategy:"queue"}).then((function(){}))}},{key:"internalClose",value:function(){return this.dispose(),this.messageHandler.request({method:"file/close",params:{id:this.id}}).then((function(){}))}}]),n}(h.Disposable);function Oe(e,t){var n="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"===typeof e)return Pe(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Pe(e,t)}(e))||t&&e&&"number"===typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,o=!0,a=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){a=!0,s=e},f:function(){try{o||null==n.return||n.return()}finally{if(a)throw s}}}}function Pe(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Re(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Ie(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Re(Object(n),!0).forEach((function(t){(0,p.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Re(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var De=function(){function e(t,n,r){var i=this;(0,s.Z)(this,e),this.messageHandler=t,this.fs=n,this.workspacePath=r,this.onFileOpenEmitter=new h.Emitter,this.onFileOpen=this.onFileOpenEmitter.event,this.onFileJoinEmitter=new h.Emitter,this.onFileJoin=this.onFileJoinEmitter.event,this.onFileLeaveEmitter=new h.Emitter,this.onFileLeave=this.onFileLeaveEmitter.event,this.onFileSaveEmitter=new h.Emitter,this.onFileSave=this.onFileSaveEmitter.event,this.onFileMoveEmitter=new h.Emitter,this.onFileMove=this.onFileMoveEmitter.event,this.onFileDeleteEmitter=new h.Emitter,this.onFileDelete=this.onFileDeleteEmitter.event,this.openedPaths=new h.BidirectionalMap,this.openFiles=new Map,this.pendingFiles=new Map,t.onNotification("file/join",(function(e){i.onFileJoinEmitter.fire(e)})),t.onNotification("file/save",(function(e){i.onFileSaveEmitter.fire(Ie(Ie({},e),{},{path:n.getPathFromId(e.id)}))})),t.onNotification("file/leave",(function(e){i.onFileLeaveEmitter.fire(e)})),n.onFSSync((function(){var e,t=Oe(i.openFiles.values());try{for(t.s();!(e=t.n()).done;){var r=e.value.object,s=r.id;if(!i.openedPaths.getKey(s)){var o=n.getPathFromId(s);o?r.path!==o&&(i.onFileMoveEmitter.fire({id:s,newPath:o,oldPath:r.path}),r.updatePath(o)):i.onFileDeleteEmitter.fire({id:s,path:r.path})}}}catch(a){t.e(a)}finally{t.f()}}))}return(0,i.Z)(e,[{key:"registerFile",value:function(e,t){var n=this,r=t.id,i=this.openFiles.get(r);if(i)return i;var s=new Se(e,t,this.messageHandler),o=new we(s,(function(){n.openFiles.delete(a),n.openedPaths.deleteByValue(a),s.internalClose()})),a=o.object.id;return this.openFiles.set(a,o),this.onFileOpenEmitter.fire(o.object),o}},{key:"getFileIdFromPath",value:function(e){var t=this.fs.getIdFromPath(e);return t&&this.fs.isFile(t)?t:this.openedPaths.getValue(e)}},{key:"getPathFromFileId",value:function(e){var t;return null!==(t=this.openedPaths.getKey(e))&&void 0!==t?t:this.fs.getPathFromId(e)}},{key:"getOpenedFile",value:function(e){var t=this.openFiles.get(e);if(t)return t.object}},{key:"getOpenFiles",value:function(){return Array.from(this.openFiles.values())}},{key:"openFile",value:function(e){var t=this,n=this.openFiles.get(e);if(n)return Promise.resolve(n.acquire());var r=this.pendingFiles.get(e)||this.messageHandler.request({method:"file/open",params:{id:e}}).then((function(e){return t.registerFile(t.getPathFromFileId(e.id),e)})).finally((function(){t.pendingFiles.delete(e)}));return this.pendingFiles.set(e,r),r.then((function(e){return e.acquire()}))}},{key:"openFileByPath",value:function(e){var t=this,n=this.getFileIdFromPath(e);if(n)return this.openFile(n);var r=this.pendingFiles.get(e)||this.messageHandler.request({method:"file/openByPath",params:{path:e}}).then((function(n){return t.openedPaths.set(e,n.id),t.registerFile(e,n)})).finally((function(){t.pendingFiles.delete(e)}));return this.pendingFiles.set(e,r),r.then((function(e){return e.acquire()}))}},{key:"createDocumentOperationFromDiff",value:function(e,t){return h.ot.createDiffTextOperation(e,t)}},{key:"resync",value:function(){var e=(0,r.Z)(l().mark((function e(){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all(Array.from(this.openFiles.values()).map((function(e){return e.object.resync()})));case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"getIdFromWorkspaceUriString",value:function(e){var t=this.fs.asAbsoluteWorkspacePath(e.replace(/^.*:\/\//,""));return this.getFileIdFromPath(this.fs.absoluteToRelativeWorkspacePath(t))}},{key:"dispose",value:function(){this.onFileJoinEmitter.dispose(),this.onFileLeaveEmitter.dispose(),this.onFileSaveEmitter.dispose()}}]),e}(),Fe=function(){function e(t){var n=this;(0,s.Z)(this,e),this.messageHandler=t,this.statusUpdatedEmitter=new h.Emitter,this.onStatusUpdated=this.statusUpdatedEmitter.event,this.statusErrorEmitter=new h.Emitter,this.onStatusError=this.statusErrorEmitter.event,this.targetDiffEmitter=new h.Emitter,this.onTargetDiffUpdated=this.targetDiffEmitter.event,this.remotesUpdatedEmitter=new h.Emitter,this.onRemotesUpdated=this.remotesUpdatedEmitter.event,this.remotesErrorEmitter=new h.Emitter,this.onRemotesError=this.remotesErrorEmitter.event,this.pullStartedEmitter=new h.Emitter,this.onPullStarted=this.pullStartedEmitter.event,this.pullFinishedEmitter=new h.Emitter,this.onPullFinished=this.pullFinishedEmitter.event,this.commitStartedEmitter=new h.Emitter,this.onCommitStarted=this.commitStartedEmitter.event,this.commitFinishedEmitter=new h.Emitter,this.onCommitFinished=this.commitFinishedEmitter.event,this.branchRenamedEmitter=new h.Emitter,this.onBranchRenamed=this.branchRenamedEmitter.event,this.status=this.createGitStatusValue(),this.targetDiff=this.createTargetDiffStatusValue(),t.onNotification("git/status",(function(e){n.status.set(e)})),this.remotes=this.createRemotesValue(),t.onNotification("git/pullStarted",(function(){n.pullStartedEmitter.fire()})),t.onNotification("git/remotes",(function(e){n.remotes.set(e)})),t.onNotification("git/pullFinished",(function(){n.pullFinishedEmitter.fire()})),t.onNotification("git/commitStarted",(function(e){n.commitStartedEmitter.fire(e)})),t.onNotification("git/commitFinished",(function(e){n.commitFinishedEmitter.fire(e)})),t.onNotification("git/renameBranch",(function(e){n.branchRenamedEmitter.fire(e)}))}return(0,i.Z)(e,[{key:"createGitStatusValue",value:function(){var e=this,t=new K({target:{ahead:0,behind:0,branch:null,safe:!0,head:null},remote:{ahead:0,behind:0,branch:null,safe:!0,head:null},changedFiles:{},commits:[],conflicts:!1,deletedFiles:[],localChanges:!1,branch:null,isMerging:!1},(function(){return e.messageHandler.request({method:"git/status",params:{}})}));return t.onChange((function(t){var n=t.value;e.statusUpdatedEmitter.fire(n),n.head!==e.currentHeadHash&&e.targetDiff.refresh()})),t.onError((function(t){return e.statusErrorEmitter.fire(t)})),t}},{key:"createTargetDiffStatusValue",value:function(){var e=this,t=new K(void 0,(0,r.Z)(l().mark((function t(){var n;return l().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=e.status.getInitPromise()){t.next=3;break}return t.abrupt("return",Promise.resolve({files:[]}));case 3:return t.abrupt("return",n.then((function(){var t=e.getStatus();return null===t.target.branch?Promise.resolve({files:[]}):(e.currentHeadHash=t.head,e.messageHandler.request({method:"git/diffStatus",params:{base:"origin/".concat(t.target.branch),head:"HEAD"}}))})));case 4:case"end":return t.stop()}}),t)}))));return t.onChange((function(t){var n=t.value;n&&e.targetDiffEmitter.fire(n)})),t}},{key:"createRemotesValue",value:function(){var e=this,t=new K({origin:"",upstream:""},(function(){return e.messageHandler.request({method:"git/remotes",params:{}})}));return t.onChange((function(t){var n=t.value;return e.remotesUpdatedEmitter.fire(n)})),t.onError((function(t){return e.remotesErrorEmitter.fire(t)})),t.get(),t}},{key:"pushToRemote",value:function(e,t){return this.messageHandler.request({method:"git/pushToRemote",params:{url:e,branch:t}})}},{key:"resetLocalWithRemote",value:function(){return this.messageHandler.request({method:"git/resetLocalWithRemote",params:{}})}},{key:"getStatus",value:function(){return this.status.get()}},{key:"getRemotes",value:function(){return this.remotes.get()}},{key:"getTargetDiffStatus",value:function(){return this.targetDiff.get()}},{key:"resync",value:function(){this.status.refresh(),this.remotes.refresh()}},{key:"compare",value:function(e){return this.messageHandler.request({method:"git/targetDiff",params:{branch:e}})}},{key:"pull",value:function(e,t){return this.messageHandler.request({method:"git/pull",params:{branch:e,force:t}})}},{key:"commit",value:function(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return this.messageHandler.request({method:"git/commit",params:{message:e,paths:t,push:n}})}},{key:"push",value:function(){return this.messageHandler.request({method:"git/push",params:null})}},{key:"discard",value:function(e){return this.messageHandler.request({method:"git/discard",params:{paths:e}}).then((function(e){return e.paths}))}},{key:"renameBranch",value:function(e,t){return this.messageHandler.request({method:"git/renameBranch",params:{oldBranch:e,newBranch:t}},{seamlessForkStrategy:"queue"})}},{key:"remoteContent",value:function(e){var t=e.reference,n=e.filepath;return this.messageHandler.request({method:"git/remoteContent",params:{reference:t,path:n}})}},{key:"checkoutInitialBranch",value:function(){return this.messageHandler.request({method:"git/checkoutInitialBranch",params:{}})}},{key:"transposeLines",value:function(e){return this.messageHandler.request({method:"git/transposeLines",params:e})}}]),e}(),Ne=n(57302);function He(e,t){var n="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"===typeof e)return Ze(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Ze(e,t)}(e))||t&&e&&"number"===typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,o=!0,a=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){a=!0,s=e},f:function(){try{o||null==n.return||n.return()}finally{if(a)throw s}}}}function Ze(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var xe=n.n(Ne)()("pitcher:language-client"),Te=function(){function e(t,n){var r=this;(0,s.Z)(this,e),this.messageHandler=t,this.fileClient=n,this.globCache=new h.GlobCache,this.lspNotificationEmitter=new h.Emitter,this.onLspNotification=this.lspNotificationEmitter.event,this.lspServerRequestEmitter=new h.Emitter,this.onLspServerRequest=this.lspServerRequestEmitter.event,this.languagesUpdatedEmitter=new h.Emitter,this.onLanguagesUpdated=this.languagesUpdatedEmitter.event,this.languagesErrorEmitter=new h.Emitter,this.onLanguagesError=this.languagesErrorEmitter.event,this.languages=this.createLanguagesValue(),t.onNotification("language/lspNotification",(function(e){r.lspNotificationEmitter.fire(e)})),t.onNotification("language/lspServerRequest",(function(e){r.lspServerRequestEmitter.fire(e)}))}return(0,i.Z)(e,[{key:"createLanguagesValue",value:function(){var e=this,t=new K([],(function(){return e.messageHandler.request({method:"language/list",params:{}}).then((function(e){return e.languages}))}));return t.onChange((function(t){var n=t.value;e.globCache.clear(),e.languagesUpdatedEmitter.fire(n)})),t.onError((function(t){return e.languagesErrorEmitter.fire(t)})),t}},{key:"getLanguages",value:function(){return this.languages.get()}},{key:"resync",value:function(){return this.languages.refresh()}},{key:"sendLSPRequest",value:function(){var e=(0,r.Z)(l().mark((function e(t){var n,r,i,s,o,a=this;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=Date.now(),r=this.getLSPRelatedFile(t.message),i={queueForReconnect:"initialize"===t.message.method,timeoutMs:6e5},r&&r.document&&r.document.otClient.hasQueuedOperation){e.next=15;break}return e.prev=4,e.next=7,this.messageHandler.request({method:"language/lspRequest",params:t},i);case 7:return s=e.sent,xe('LSP request "%s" took %dms',t.message.method,Date.now()-n),e.abrupt("return",{type:"ok",result:s});case 12:return e.prev=12,e.t0=e.catch(4),e.abrupt("return",{type:"error",error:e.t0});case 15:return o=r.document,e.abrupt("return",new Promise((function(e){var r=o.otClient.onOperationAck((function(){r.dispose(),a.messageHandler.request({method:"language/lspRequest",params:t},i).then((function(r){xe('LSP request "%s" took %dms, after waiting for operations to be sent',t.message.method,Date.now()-n),e({type:"ok",result:r})})).catch((function(t){e({type:"error",error:t})}))}))})));case 17:case"end":return e.stop()}}),e,this,[[4,12]])})));return function(t){return e.apply(this,arguments)}}()},{key:"sendLSPServerResponse",value:function(e){var t=this;return new Promise((function(n,r){t.messageHandler.request({method:"language/lspServerResponse",params:e}).then(n).catch(r)}))}},{key:"getLanguageId",value:function(e){var t,n=He(this.languages.get());try{for(n.s();!(t=n.n()).done;){var r,i=t.value,s=He(i.globs);try{for(s.s();!(r=s.n()).done;){var o=r.value,a=this.globCache.get(o);if(e.match(a))return i.id}}catch(c){s.e(c)}finally{s.f()}}}catch(c){n.e(c)}finally{n.f()}return"text"}},{key:"isLSPDocumentMessage",value:function(e){return Boolean(e.params&&e.params.textDocument)}},{key:"getLSPRelatedFile",value:function(e){if(this.isLSPDocumentMessage(e)){var t=this.fileClient.getIdFromWorkspaceUriString(e.params.textDocument.uri);if(t){var n=this.fileClient.getOpenedFile(t);if(n)return n}}}}]),e}();function qe(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,c.Z)(e);if(t){var i=(0,c.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,a.Z)(this,n)}}var je=function(e){(0,o.Z)(n,e);var t=qe(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this)).onNotificationEmitter=new h.Emitter,r.onNotification=r.onNotificationEmitter.event,r.notifications={},r.onDismissNotificationEmitter=new h.Emitter,r.onDismissNotification=r.onDismissNotificationEmitter.event,r.addDisposable(e.onMessage((function(t){if("notification/notify"===t.method){var n=new Me(t.params);r.notifications[n.id]=n,r.addDisposable(n.onNotificationResponse((function(t){delete r.notifications[n.id],e.request({method:"notification/notifyResponse",params:{notificationId:n.id,response:t}})}))),r.onNotificationEmitter.fire(n)}else if("notification/dismiss"===t.method){var i=r.notifications[t.params.notificationId];i&&(i.dismiss(),delete r.notifications[i.id],r.onDismissNotificationEmitter.fire(t.params))}}))),r}return n}(h.Disposable),Me=function(e){(0,o.Z)(n,e);var t=qe(n);function n(e){var r;return(0,s.Z)(this,n),(r=t.call(this)).onNotificationResponseEmitter=r.addDisposable(new h.Emitter),r.onNotificationResponse=r.onNotificationResponseEmitter.event,r.onNotificationDismissEmitter=r.addDisposable(new h.Emitter),r.onNotificationDismiss=r.onNotificationDismissEmitter.event,r.id=e.notificationId,r.type=e.type,r.message=e.message,r.actions=e.actions,r}return(0,i.Z)(n,[{key:"dismiss",value:function(){this.onNotificationDismissEmitter.fire()}},{key:"respond",value:function(e){this.onNotificationResponseEmitter.fire(e)}}]),n}(h.Disposable),Le=function(){function e(t){var n=this;(0,s.Z)(this,e),this.messageHandler=t,this.portsUpdatedEmitter=new h.Emitter,this.onPortsUpdated=this.portsUpdatedEmitter.event,this.portsErrorEmitter=new h.Emitter,this.onPortsError=this.portsErrorEmitter.event,this.ports=this.createPortsValue(),this.readyPromise=this.ports.getInitPromise(),t.onNotification("port/changed",(function(e){var t=e.list;n.ports.set(t)}))}return(0,i.Z)(e,[{key:"createPortsValue",value:function(){var e=this,t=new K([],(function(){return e.messageHandler.request({method:"port/list",params:{}}).then((function(e){return e.list}))}),{fetchEagerly:!0});return t.onChange((function(t){var n=t.value;return e.portsUpdatedEmitter.fire(n)})),t.onError((function(t){return e.portsErrorEmitter.fire(t)})),t}},{key:"getPorts",value:function(){return this.ports.get()}},{key:"resync",value:function(){return this.ports.refresh()}}]),e}(),Ae=function(){function e(t){var n=this;(0,s.Z)(this,e),this.messageHandler=t,this.setupProgressUpdateEmitter=new h.Emitter,this.onSetupProgressUpdate=this.setupProgressUpdateEmitter.event,this.setupProgressErrorEmitter=new h.Emitter,this.onSetupProgressError=this.setupProgressErrorEmitter.event,this.setupProgress=this.createSetupProgressValue(),this.readyPromise=this.setupProgress.getInitPromise(),t.onNotification("setup/progress",(function(e){return n.setupProgress.set(e)}))}return(0,i.Z)(e,[{key:"createSetupProgressValue",value:function(){var e=this,t=new K({state:"IDLE",currentStepIndex:0,steps:[]},(function(){return e.messageHandler.request({method:"setup/get",params:{}})}),{fetchEagerly:!0});return t.onChange((function(t){var n=t.value;return e.setupProgressUpdateEmitter.fire(n)})),t.onError((function(t){return e.setupProgressErrorEmitter.fire(t)})),t}},{key:"getProgress",value:function(){return this.setupProgress.get()}},{key:"resync",value:function(){return this.setupProgress.refresh()}},{key:"skipStep",value:function(e){return this.messageHandler.request({method:"setup/skip",params:{stepIndexToSkip:e}})}},{key:"skipAll",value:function(){return this.messageHandler.request({method:"setup/skipAll",params:null})}},{key:"setStep",value:function(e){return this.messageHandler.request({method:"setup/setStep",params:{stepIndex:e}})}}]),e}(),Ue=function(){function e(t){var n=this;(0,s.Z)(this,e),this.messageHandler=t,this.openShells=new Map,this.shellCreatedEmitter=new h.Emitter,this.onShellCreated=this.shellCreatedEmitter.event,this.shellRestartedEmitter=new h.Emitter,this.onShellRestarted=this.shellRestartedEmitter.event,this.shellTerminatedEmitter=new h.Emitter,this.onShellTerminated=this.shellTerminatedEmitter.event,this.shellNameChangeEmitter=new h.Emitter,this.onShellNameChange=this.shellNameChangeEmitter.event,this.shellExitedEmitter=new h.Emitter,this.onShellExited=this.shellExitedEmitter.event,this.shellsUpdatedEmitter=new h.Emitter,this.onShellsUpdated=this.shellsUpdatedEmitter.event,this.shellsErrorEmitter=new h.Emitter,this.onShellsError=this.shellsErrorEmitter.event,this.shellOutEmitter=new h.Emitter,this.onShellOut=this.shellOutEmitter.event,this.shells=this.createShellsValue(),this.readyPromise=this.shells.getInitPromise(),t.onNotification("shell/terminate",(function(e){var t=e.shellId,r=e.author;n.shellTerminatedEmitter.fire({shellId:t,author:r}),n.deleteShell(t)})),t.onNotification("shell/exit",(function(e){var t=e.shellId,r=e.shellType,i=e.exitCode;n.shellExitedEmitter.fire({shellId:t,exitCode:i}),"TERMINAL"===r&&n.deleteShell(t)})),t.onNotification("shell/create",(function(e){n.shellCreatedEmitter.fire(e),n.shells.update((function(t){return t.concat(e)}))})),t.onNotification("shell/restart",(function(e){var t=e.shellId;return n.shellRestartedEmitter.fire({shellId:t})})),t.onNotification("shell/out",(function(e){return n.shellOutEmitter.fire(e)})),t.onNotification("shell/rename",(function(e){var t=e.shell;n.shells.update((function(e){return[].concat((0,ie.Z)(e.filter((function(e){return e.shellId!==t.shellId}))),[t])})),n.shellNameChangeEmitter.fire({shellId:t.shellId})}))}return(0,i.Z)(e,[{key:"createShellsValue",value:function(){var e=this,t=new K([],(function(){return e.messageHandler.request({method:"shell/list",params:{}}).then((function(e){return e.shells}))}),{fetchEagerly:!0});return t.onChange((function(t){var n=t.value;return e.shellsUpdatedEmitter.fire(n)})),t.onError((function(t){return e.shellsErrorEmitter.fire(t)})),t}},{key:"closeShell",value:function(e){this.openShells.delete(e)}},{key:"deleteShell",value:function(e){this.shells.update((function(t){return t.filter((function(t){return t.shellId!==e}))})),this.closeShell(e)}},{key:"getShells",value:function(){return this.shells.get()}},{key:"getShellName",value:function(e){var t;return(null===(t=this.shells.get().find((function(t){return t.shellId===e})))||void 0===t?void 0:t.name)||null}},{key:"resync",value:function(){var e=this;this.shells.refresh(),Array.from(this.openShells.entries()).forEach((function(t){var n=(0,ke.Z)(t,2),r=n[0],i=n[1];return e.open(r,i).catch((function(){e.shellTerminatedEmitter.fire({shellId:r,author:"connection loss"})}))}))}},{key:"create",value:function(e,t,n){var r=this;return this.messageHandler.request({method:"shell/create",params:{projectPath:e,command:n,size:t}}).then((function(e){return r.openShells.set(e.shellId,t),e}))}},{key:"open",value:function(e,t){var n=this;return this.messageHandler.request({method:"shell/open",params:{shellId:e,size:t}}).then((function(e){return n.openShells.set(e.shellId,t),e}))}},{key:"close",value:function(e){var t=this;return this.messageHandler.request({method:"shell/close",params:{shellId:e}}).then((function(n){return t.closeShell(e),n}))}},{key:"restart",value:function(e){return this.messageHandler.request({method:"shell/restart",params:{shellId:e}})}},{key:"delete",value:function(e){var t=this;return this.messageHandler.request({method:"shell/terminate",params:{shellId:e}}).then((function(n){return t.deleteShell(e),n}))}},{key:"send",value:function(e,t,n){return this.messageHandler.request({method:"shell/in",params:{shellId:e,input:t,size:n}})}},{key:"resize",value:function(e,t){var n=this;return this.messageHandler.request({method:"shell/resize",params:{shellId:e,size:t}},{queueForReconnect:!1}).then((function(r){return n.openShells.set(e,t),r}))}},{key:"rename",value:function(e,t){return this.messageHandler.request({method:"shell/rename",params:{shellId:e,name:t}})}}]),e}(),Be=function(){function e(t){var n=this;(0,s.Z)(this,e),this.messageHandler=t,this.hibernateEmitter=new h.Emitter,this.onHibernate=this.hibernateEmitter.event,this.metricsEmitter=new h.Emitter,this.onMetricsUpdated=this.metricsEmitter.event,this.initStatusEmitter=new h.Emitter,this.onInitStatusUpdate=this.initStatusEmitter.event,this.metrics=this.createMetricsValue(),t.onNotification("system/hibernate",(function(){n.hibernateEmitter.fire({})})),t.onNotification("system/metrics",(function(e){n.metrics.set(e)})),t.onNotification("system/initStatus",(function(e){n.initStatusEmitter.fire(e)}))}return(0,i.Z)(e,[{key:"createMetricsValue",value:function(){var e=this,t=new K(void 0,(function(){return e.messageHandler.request({method:"system/metrics",params:{}}).then((function(e){return e}))}));return t.onChange((function(t){var n=t.value;return e.metricsEmitter.fire(n)})),t}},{key:"getMetrics",value:function(){return this.metrics.get()}},{key:"startMetricsPollingAtInterval",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5e3,n=function(){e.messageHandler.request({method:"system/metrics",params:{}},{queueForReconnect:!1}).then((function(t){return e.metrics.set(t)})).catch((function(){}))};n();var r=setInterval(n,t);return function(){clearInterval(r)}}},{key:"resync",value:function(){}},{key:"update",value:function(){return this.messageHandler.request({method:"system/update",params:{}})}},{key:"hibernate",value:function(){return this.messageHandler.request({method:"system/hibernate",params:{}})}}]),e}();function _e(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Ve(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?_e(Object(n),!0).forEach((function(t){(0,p.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):_e(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var We=function(){function e(t){var n=this;(0,s.Z)(this,e),this.messageHandler=t,this.taskListUpdateEmitter=new h.Emitter,this.onTaskListUpdate=this.taskListUpdateEmitter.event,this.taskUpdateEmitter=new h.Emitter,this.onTaskUpdate=this.taskUpdateEmitter.event,this.taskPortOpenedEmitter=new h.Emitter,this.onTaskPortOpened=this.taskPortOpenedEmitter.event,this.taskStartedEmitter=new h.Emitter,this.onTaskStarted=this.taskStartedEmitter.event,this.unassignedPortOpenedEmitter=new h.Emitter,this.onUnassignedPortOpened=this.unassignedPortOpenedEmitter.event,this.unassignedPortClosedEmitter=new h.Emitter,this.onUnassignedPortClosed=this.unassignedPortClosedEmitter.event,this.configParseErrorEmitter=new h.Emitter,this.onConfigParseError=this.configParseErrorEmitter.event,this.tasksValue=this.createTasksValue(),this.readyPromise=this.tasksValue.getInitPromise(),t.onNotification("task/listUpdate",(function(e){n.tasksValue.set(e)})),t.onNotification("task/update",(function(e){var t,r,i=e.id,s=n.tasksValue.get().tasks[i];n.tasksValue.update((function(t){return Ve(Ve({},t),{},{tasks:Ve(Ve({},t.tasks),{},(0,p.Z)({},i,e))})})),n.taskUpdateEmitter.fire(e),"RUNNING"!==(null===s||void 0===s||null===(t=s.shell)||void 0===t?void 0:t.status)&&"RUNNING"===(null===(r=e.shell)||void 0===r?void 0:r.status)&&n.taskStartedEmitter.fire({taskId:i}),s&&e.ports.forEach((function(e){!s.ports.some((function(t){return t.port===e.port}))&&n.taskPortOpenedEmitter.fire({taskId:i,port:e})}))})),t.onNotification("shell/exit",(function(e){var t=e.shellId,r=e.exitCode,i=n.tasksValue.get().tasks,s=Object.values(i).find((function(e){var n;return(null===(n=e.shell)||void 0===n?void 0:n.shellId)===t}));if(s&&null!==s.shell){var o=Ve(Ve({},s),{},{shell:Ve(Ve({},s.shell),{},{status:r>0?"ERROR":"FINISHED",exitCode:r})});n.tasksValue.update((function(e){return Ve(Ve({},e),{},{tasks:Ve(Ve({},e.tasks),{},(0,p.Z)({},o.id,o))})})),n.taskUpdateEmitter.fire(o)}})),t.onNotification("task/unassignedPortOpened",(function(e){n.unassignedPortOpenedEmitter.fire(e)})),t.onNotification("task/unassignedPortClosed",(function(e){n.unassignedPortClosedEmitter.fire(e)})),t.onNotification("task/configParseError",(function(e){var t=e.error;n.configParseErrorEmitter.fire(t)}))}return(0,i.Z)(e,[{key:"createTasksValue",value:function(){var e=this,t=new K({tasks:{},validationErrors:[]},(function(){return e.messageHandler.request({method:"task/list",params:{}}).then((function(e){return e}))}),{fetchEagerly:!0});return t.onChange((function(t){var n=t.value;e.taskListUpdateEmitter.fire(n)})),t}},{key:"getTasks",value:function(){return this.tasksValue.get()}},{key:"getTask",value:function(e){return this.tasksValue.get().tasks[e]}},{key:"resync",value:function(){return this.tasksValue.refresh()}},{key:"runTask",value:function(e){var t,n=this.tasksValue.get().tasks[e];return n&&"KILLED"===(null===(t=n.shell)||void 0===t?void 0:t.status)&&(n.shell=null),this.messageHandler.request({method:"task/run",params:{taskId:e}})}},{key:"runCommand",value:function(e,t){return this.messageHandler.request({method:"task/runCommand",params:{command:e,saveToConfig:t}})}},{key:"stopTask",value:function(e){return this.messageHandler.request({method:"task/stop",params:{taskId:e}})}},{key:"updateTask",value:function(e,t){return this.messageHandler.request({method:"task/update",params:{taskId:e,taskFields:t}},{seamlessForkStrategy:"queue"})}},{key:"createTask",value:function(){var e=(0,r.Z)(l().mark((function e(t){var n,r,i,s,o=arguments;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=o.length>1&&void 0!==o[1]&&o[1],e.next=3,this.messageHandler.request({method:"task/create",params:{taskFields:t,startTask:n}},{seamlessForkStrategy:"queue"});case 3:if(r=e.sent,this.tasksValue.set(r),i=this.tasksValue.get().tasks,s=Object.values(i).find((function(e){return e.command===t.command}))){e.next=9;break}throw new Error("Cannot find the task running '".concat(t.command,"'"));case 9:return e.abrupt("return",s);case 10:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"saveToConfig",value:function(e){return this.messageHandler.request({method:"task/saveToConfig",params:{taskId:e}})}},{key:"generateConfigFile",value:function(){var e=this;return new Promise((function(t,n){var r=e.messageHandler.onNotification("fs/operations",(function(e){var n=e.operations.map((function(e){return e.operation})).find((function(e){return"create"===e.type&&"tasks.json"===e.newEntry.name}));if(n&&"create"===n.type){var i=n.newEntry.id;t(i),r()}}));setTimeout((function(){n(new Error("Config file was not generated")),r()}),5e3),e.messageHandler.request({method:"task/generateConfig",params:{}}).catch((function(e){n(e),r()}))}))}}]),e}(),Ge={GIT_BRANCH_OUT_OF_SYNC:"0.209.11",SANDBOX_TO_REPOSITORY:"0.209.9",VM_METRICS:"0.212.0",GIT_LOGS_ON_PROTECTED_BRANCHES:"0.233.0",REMOTE_BRANCH_PRESENCE_DETECTION:"0.242.0",SET_BRANCH_PROTECTION:"0.248.4",SHELL_RENAME:"0.254.0"};n(73656);function Je(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=(0,c.Z)(e);if(t){var i=(0,c.Z)(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return(0,a.Z)(this,n)}}h.ot.AsyncDocument;var Qe=5e3,Ye=1e4;function ze(e,t){return"".concat(e.pitcherURL,"/?token=").concat(e.pitcherToken).concat(t?"&reconnectToken=".concat(t):"")}var $e=function(){function e(t){var n=this;(0,s.Z)(this,e),this.lastFocusTimestamp=Date.now(),this.isFocused=!0,this.state=new d.G({state:"CONNECTED",lastActivity:Date.now(),lastFocus:Date.now(),lastDisconnected:Date.now()}),this.onStateChange=this.state.onTransition,this.instanceId=t.instanceId,this.hostResponse=t.hostResponse,this.joinResult=t.joinResult,this.messageHandler=t.messageHandler,this.onFocusChange=t.onFocusChange,this.onInstanceChangeRequired=this.messageHandler.onInstanceChangeRequired,this.appId=t.appId,this.subscriptions=t.subscriptions,this.requestPitcherInstance=t.requestPitcherInstance,this.hostResponse=t.hostResponse,this.subscribeConnection(t.initialConnection),this.connection=t.initialConnection;var r=new pe(this.workspacePath,this.messageHandler),i=new De(this.messageHandler,r,this.workspacePath),o=new te(this.messageHandler);this.clients={fs:r,client:o,shell:new Ue(this.messageHandler),port:new Le(this.messageHandler),file:i,language:new Te(this.messageHandler,i),git:new Fe(this.messageHandler),setup:new Ae(this.messageHandler),channel:new $({clientClient:o,currentClient:this.currentClient,messageHandler:this.messageHandler}),task:new We(this.messageHandler),system:new Be(this.messageHandler),command:new ne(this.messageHandler),notification:new je(this.messageHandler),ai:new B(this.messageHandler)},this.onMessageError=this.messageHandler.onError,this.onMessage=function(e){return n.messageHandler.onMessage(e)},this.messageHandler.onInstanceChangeRequired((function(){n.messageHandler.setOnSendRequest((function(){throw new Error("Instance change required")}))})),this.clients.system.onHibernate((function(){n.state.set({state:"HIBERNATED",wasFocused:n.isFocused,disconnectedAt:Date.now()}),n.connection.dispose()})),this.clients.client.onClientsUpdated((function(e){var t=e.find((function(e){return e.clientId===n.currentClient.clientId}));!t||n.currentClient.name===t.name&&n.currentClient.avatarUrl||(n.currentClient.name=t.name,n.currentClient.avatarUrl=t.avatarUrl)})),this.onFocusChange((function(e){n.isFocused=e;var t=n.state.get();e&&(n.lastFocusTimestamp=Date.now()),e&&"CONNECTED"===t.state?n.connection.ping(5e3):!e||"DISCONNECTED"!==t.state&&"HIBERNATED"!==t.state||n.attemptReconnect({disconnectReason:"DISCONNECTED"===t.state?t.reason:"HIBERNATED",disconnectedAt:t.disconnectedAt}).catch((function(){}))}))}return(0,i.Z)(e,[{key:"currentClient",get:function(){return this.joinResult.client}},{key:"capabilities",get:function(){return this.joinResult.capabilities}},{key:"permissions",get:function(){return this.joinResult.permissions}},{key:"pitcherVersion",get:function(){return this.joinResult.version}},{key:"pitcherManagerVersion",get:function(){return this.hostResponse.pitcherManagerVersion}},{key:"pitcherProtocolVersion",get:function(){return this.joinResult.protocolVersion}},{key:"workspacePath",get:function(){return this.hostResponse.workspacePath}},{key:"cluster",get:function(){return this.hostResponse.cluster}},{key:"reconnectToken",get:function(){return this.joinResult.reconnectToken}},{key:"subscribeConnection",value:function(e){var t=this,n=e.onMessage((function(e){t.messageHandler.receiveMessage(e)}));this.messageHandler.setOnSendRequest((function(n){var r=t.state.get();if("CONNECTED"!==r.state&&"client/join"!==n.method)throw!t.isFocused||"DISCONNECTED"!==r.state&&"HIBERNATED"!==r.state||t.attemptReconnect({disconnectReason:"DISCONNECTED"===r.state?r.reason:"HIBERNATED",disconnectedAt:r.disconnectedAt}).catch((function(){})),new Error("Not able to send message in state "+r.state);e.send(n.message)}));var r=e.onDisconnected((function(e){var n=e.reason,r=e.code,i=e.wasClean,s=t.state.get();t.isFocused&&"CONNECTED"===s.state?t.attemptReconnect({disconnectReason:n,disconnectedAt:Date.now()}).catch((function(){})):t.state.set({state:"DISCONNECTED",reason:n,code:r,wasClean:i,wasFocused:t.isFocused,disconnectedAt:Date.now()})}));e.onWillDispose((function(){n.dispose(),r.dispose()}))}},{key:"resolveNewConnection",value:function(){var e=(0,r.Z)(l().mark((function e(){var t;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,H(ze(this.hostResponse,this.reconnectToken));case 2:return t=e.sent,this.subscribeConnection(t),e.next=6,this.clients.client.join({clientInfo:{protocolVersion:f.version,appId:this.appId},asyncProgress:!1,subscriptions:this.subscriptions});case 6:return this.joinResult=e.sent,this.state.set({state:"CONNECTED",lastActivity:this.connection.lastActivity,lastFocus:this.lastFocusTimestamp,lastDisconnected:Date.now()}),e.abrupt("return",t);case 9:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"reconnect",value:function(){var e=(0,r.Z)(l().mark((function e(){var t=this;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.state.match({DISCONNECTED:function(e){var n=e.reason,r=e.disconnectedAt;return t.attemptReconnect({disconnectReason:n,disconnectedAt:r})},CONNECTED:function(){return t.attemptReconnect({disconnectReason:"MANUAL_RECONNECT",disconnectedAt:Date.now()})},RECONNECTING:function(e){return e.reconnectPromise},_:function(){}}));case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"attemptReconnect",value:function(e){var t=this,n=e.disconnectReason,i=e.disconnectedAt,s=1,o=this.isFocused;return function e(){var a=new Promise((function(n,i){setTimeout((0,r.Z)(l().mark((function r(){return l().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,t.requestPitcherInstance(t.instanceId);case 3:return t.hostResponse=r.sent,r.next=6,t.resolveNewConnection();case 6:return t.connection=r.sent,r.next=9,t.messageHandler.flushReconnectQueue();case 9:return r.next=11,Promise.all([t.clients.client.resync(),t.clients.git.resync(),t.clients.port.resync(),t.clients.setup.resync(),t.clients.shell.resync(),t.clients.language.resync(),t.clients.task.resync(),t.clients.system.resync(),t.clients.command.resync(),t.clients.fs.resync(),t.clients.file.resync()]);case 11:n(),r.next=17;break;case 14:r.prev=14,r.t0=r.catch(0),s<3?(s++,e().then(n).catch(i)):i(r.t0);case 17:case"end":return r.stop()}}),r,null,[[0,14]])}))),(s-1)*Qe)})).catch((function(e){throw t.state.set({state:"DISCONNECTED",code:-1,disconnectedAt:i,reason:String(e),wasClean:!1,wasFocused:t.isFocused}),e}));return t.state.set({state:"RECONNECTING",disconnectReason:n,wasFocused:o,attempt:s,lastActivity:t.connection.lastActivity,disconnectedAt:i,lastFocus:t.lastFocusTimestamp,reconnectPromise:a}),a}()}},{key:"hasFeature",value:function(e){return-1!==(0,m.compare)(this.pitcherVersion,Ge[e])}},{key:"changeInstance",value:function(){var e=(0,r.Z)(l().mark((function e(t){var n=this;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.state.match({CONNECTED:function(){var e=(0,r.Z)(l().mark((function e(){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n.connection.silence(),n.instanceId=t,e.next=4,n.requestPitcherInstance(t);case 4:return n.hostResponse=e.sent,n.connection.dispose(),e.next=8,n.resolveNewConnection();case 8:return n.connection=e.sent,n.connection.setPongDetectionTimeout(Ye),n.messageHandler.disableSeamlessFork(),n.clients.task.resync(),n.clients.client.resync(),n.clients.shell.resync(),e.next=16,n.clients.file.resync();case 16:return e.next=18,n.messageHandler.flushReconnectQueue();case 18:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),_:function(){throw new Error("You can not change instance when: "+n.state.get().state)}}));case 1:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"dispose",value:function(){this.state.dispose(),this.connection.dispose(),this.messageHandler.dispose()}}]),e}();function Ke(e){return 75*e/100+25}var Xe={message:"Starting MicroVM...",progress:0,nextProgress:20};function et(e,t){return tt.apply(this,arguments)}function tt(){return(tt=(0,r.Z)(l().mark((function e(t,n){var r,i,s,o,a,c,u,h,d;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return globalThis.__CSB__SHOW_PITCHER_MESSAGES&&console.log("[pitcher-client]: Connecting to pitcher"),e.next=3,t.requestPitcherInstance(t.instanceId);case 3:return r=e.sent,n({message:"MicroVM started, connecting...",progress:20,nextProgress:25}),e.next=7,H(ze(r));case 7:return i=e.sent,globalThis.__CSB__SHOW_PITCHER_MESSAGES&&console.log("[pitcher-client]: Setting up message handler and clients"),s=new O((function(e){i.send(e.message)}),Boolean(t.seamlessFork)),o=i.onMessage((function(e){s.receiveMessage(e)})),a=new te(s),c=new Be(s),u=c.onInitStatusUpdate((function(e){e.progress=Ke(e.progress),e.nextProgress=Ke(e.nextProgress),n(e)})),e.next=16,a.join({clientInfo:{protocolVersion:f.version,appId:t.appId},asyncProgress:!0,subscriptions:t.subscriptions});case 16:return h=e.sent,u.dispose(),o.dispose(),d=new $e({instanceId:t.instanceId,appId:t.appId,subscriptions:t.subscriptions,requestPitcherInstance:t.requestPitcherInstance,onFocusChange:t.onFocusChange,seamlessFork:t.seamlessFork,messageHandler:s,joinResult:h,initialConnection:i,hostResponse:r}),globalThis.__CSB__SHOW_PITCHER_MESSAGES&&console.log("[pitcher-client]: Awaiting fs initialization"),e.next=23,Promise.all([d.clients.fs.readyPromise,d.clients.port.readyPromise,d.clients.task.readyPromise,d.clients.setup.readyPromise,d.clients.shell.readyPromise]);case 23:return i.setPongDetectionTimeout(Ye),window._DEBUG_PITCHER_CLIENT=d,e.abrupt("return",d);case 26:case"end":return e.stop()}}),e)})))).apply(this,arguments)}}}]);
//# sourceMappingURL=4856-709d643b33421ae5899b.js.map